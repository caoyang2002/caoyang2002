name: Deploy Hugo site

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main  # åªåœ¨ main åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# ç¯å¢ƒå˜é‡
env:
  HUGO_VERSION: "latest"
  TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒº

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Hugo site
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # æ›´æ–°åˆ° v4
        with:
          submodules: recursive  # é€’å½’è·å–æ‰€æœ‰å­æ¨¡å—
          fetch-depth: 0
      
      - name: Cache Hugo resources
        uses: actions/cache@v3
        with:
          path: /tmp/hugo_cache
          key: ${{ runner.os }}-hugo-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugo-
      
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true
      
      - name: Build site
        run: |
          echo "Using Hugo version: $(hugo version)"
          hugo --minify --gc
        
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'  # åªåœ¨ main åˆ†æ”¯éƒ¨ç½²
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_dir: ./public
          commit_message: ${{ github.event.head_commit.message }}
          full_commit_message: ${{ github.event.head_commit.message }}
          allow_empty_commit: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          cname: your-custom-domain.com  # å¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼Œå–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹
      
      - name: Notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const { status, conclusion } = context.job
            const time = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })
            const message = `
            ğŸš€ éƒ¨ç½²çŠ¶æ€: ${conclusion}
            â° å®Œæˆæ—¶é—´: ${time}
            ğŸ“ æäº¤ä¿¡æ¯: ${context.payload.head_commit?.message || 'No commit message'}
            `
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })